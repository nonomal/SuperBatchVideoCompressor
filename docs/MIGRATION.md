# ä»æ—§SBVC.pyè¿ç§»åˆ°æ–°ç‰ˆSuperBatchVideoCompressoræŒ‡å—

æœ¬æ–‡æ¡£å¸®åŠ©ä½ ä»æ—§çš„å•æ–‡ä»¶`SBVC.py`ç¨‹åºè¿ç§»åˆ°æ–°çš„æ¨¡å—åŒ–`SuperBatchVideoCompressor`ã€‚

## ğŸ“Š æ–°æ—§åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | æ—§ç¨‹åº | æ–°ç¨‹åº | æ”¹è¿› |
|-----|--------|--------|------|
| ç¡¬ä»¶åŠ é€Ÿ | ä»…NVENC | NVENC/QSV/VideoToolbox | âœ… æ”¯æŒæ›´å¤šå¹³å° |
| ç¼–ç æ ¼å¼ | ä»…HEVC | HEVC/AVC/AV1 | âœ… æ›´å¤šé€‰æ‹© |
| å›é€€æœºåˆ¶ | ç®€å•3çº§å›é€€ | æ™ºèƒ½å¤šçº§å›é€€ | âœ… æ›´å¯é  |
| å¹¶å‘æ§åˆ¶ | å›ºå®š3çº¿ç¨‹ | å¯é…ç½®+æ™ºèƒ½è°ƒåº¦ | âœ… æ›´çµæ´» |
| é…ç½®æ–¹å¼ | ç¡¬ç¼–ç  | é…ç½®æ–‡ä»¶+å‘½ä»¤è¡Œ | âœ… æ›´æ˜“ç”¨ |
| ç ç‡æ§åˆ¶ | ç¡¬ç¼–ç å°é¡¶å€¼ | å¯é…ç½®åˆ†è¾¨ç‡å°é¡¶ | âœ… æ›´çµæ´» |
| å¤šGPUæ”¯æŒ | âŒ | âœ… | âœ… æ–°åŠŸèƒ½ |
| è·¨å¹³å° | Windows only | Windows/Linux/macOS | âœ… è·¨å¹³å° |

## ğŸš€ å¿«é€Ÿè¿ç§»æ­¥éª¤

### 1. å®‰è£…ä¾èµ–

```bash
# å®‰è£…Pythonä¾èµ–
pip install -r requirements.txt

# ç¡®ä¿FFmpegå·²å®‰è£…
ffmpeg -version
```

### 2. é…ç½®è·¯å¾„

ç¼–è¾‘`config.yaml`æ–‡ä»¶ï¼Œå°†æ—§ç¨‹åºçš„è·¯å¾„é…ç½®åˆ°æ–°ç¨‹åºï¼š

```yaml
# æ—§ç¨‹åºé…ç½®
# input_folder_path = r"F:\lada\output"
# output_folder_path = r"F:\lada\pre"
# log_folder_path = r'I:\BVC'

# å¯¹åº”çš„æ–°ç¨‹åºé…ç½®
paths:
  input: "F:/lada/output"
  output: "F:/lada/pre"
  log: "I:/BVC"
```

**æ³¨æ„**ï¼šWindowsè·¯å¾„å¯ä»¥ä½¿ç”¨ `/` æˆ– `\\`ï¼Œé¿å…ä½¿ç”¨å•ä¸ª `\`

### 3. è¿è¡Œæ–°ç¨‹åº

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰

```bash
# å•ç¼–ç å™¨æ¨¡å¼ï¼ˆä¸æ—§ç¨‹åºæœ€æ¥è¿‘ï¼‰
python main.py

# æˆ–è€…æŒ‡å®šé…ç½®æ–‡ä»¶
python main.py --config config.yaml
```

#### æ–¹å¼äºŒï¼šå‘½ä»¤è¡Œå‚æ•°

```bash
# å®Œå…¨é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è¿è¡Œ
python main.py -i "F:/lada/output" -o "F:/lada/pre" -l "I:/BVC" --hw-accel nvenc -c hevc -w 3
```

#### æ–¹å¼ä¸‰ï¼šå¤šGPUæ··åˆè°ƒåº¦æ¨¡å¼ï¼ˆæ–°åŠŸèƒ½ï¼‰

```bash
# ä½¿ç”¨å¤šç¼–ç å™¨æ··åˆè°ƒåº¦ï¼ˆæ¨èç”¨äºå¤šGPUæˆ–æ··åˆç¡¬ä»¶ç¯å¢ƒï¼‰
python main.py --multi-gpu
```

## âš™ï¸ é…ç½®è¯´æ˜

### å®Œå…¨å…¼å®¹æ—§ç¨‹åºçš„æœ€å°é…ç½®

å¦‚æœä½ æƒ³è¦æ–°ç¨‹åºçš„è¡Œä¸ºä¸æ—§ç¨‹åºå®Œå…¨ä¸€è‡´ï¼Œä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š

```yaml
paths:
  input: "F:/lada/output"
  output: "F:/lada/pre"
  log: "I:/BVC"

encoding:
  codec: "hevc"
  bitrate:
    forced: 0          # è‡ªåŠ¨è®¡ç®—ç ç‡ï¼ˆæ—§ç¨‹åºä¹Ÿæ˜¯è‡ªåŠ¨ï¼‰
    ratio: 0.5         # å‹ç¼©æ¯”ä¾‹
    min: 500000        # æœ€å°ç ç‡ä¿æŠ¤
    max_by_resolution: # æ ¹æ®åˆ†è¾¨ç‡é™åˆ¶æœ€å¤§ç ç‡ï¼ˆæ–°åŠŸèƒ½ï¼‰
      720: 1500000     # 720p: 1.5 Mbps
      1080: 3000000    # 1080p: 3 Mbps
      1440: 5000000    # 1440p (2K): 5 Mbps
      2160: 9000000    # 4K: 9 Mbps

encoders:
  enabled: ["nvenc"]   # åªä½¿ç”¨NVENC
  cpu_fallback: false  # ä¸å¯ç”¨CPUå›é€€ï¼ˆæ—§ç¨‹åºæ²¡æœ‰ï¼‰

  nvenc:
    max_concurrent: 3  # ä¸æ—§ç¨‹åºç›¸åŒ

files:
  min_size_mb: 100     # ä¸æ—§ç¨‹åºç›¸åŒ
  keep_structure: true # ä¸æ—§ç¨‹åºç›¸åŒ
```

### åˆ©ç”¨æ–°åŠŸèƒ½çš„æ¨èé…ç½®

å¦‚æœä½ æƒ³åˆ©ç”¨æ–°ç¨‹åºçš„é«˜çº§åŠŸèƒ½ï¼š

```yaml
encoders:
  enabled: ["nvenc", "qsv"]  # å¯ç”¨å¤šä¸ªç¼–ç å™¨
  cpu_fallback: true          # å¯ç”¨CPUå…œåº•

  nvenc:
    max_concurrent: 3
    fallback_to: "qsv"        # NVENCå¤±è´¥æ—¶å›é€€åˆ°QSV

scheduler:
  strategy: "least_loaded"    # ä½¿ç”¨è´Ÿè½½å‡è¡¡è°ƒåº¦
  max_total_concurrent: 6     # æé«˜æ€»å¹¶å‘æ•°
```

## ğŸ”„ åŠŸèƒ½å¯¹åº”å…³ç³»

### æ—§ç¨‹åºçš„åŠŸèƒ½åœ¨æ–°ç¨‹åºä¸­çš„å®ç°

| æ—§ç¨‹åº | æ–°ç¨‹åº | è¯´æ˜ |
|--------|--------|------|
| `force_bitrate_flag` | `encoding.bitrate.forced` | å¼ºåˆ¶ç ç‡å¼€å…³ |
| `forced_bitrate` | å‘½ä»¤è¡Œ: `--force-bitrate` | å¼ºåˆ¶ç ç‡å€¼ |
| ç¡¬ç¼–ç æœ€å¤§ç ç‡ | `encoding.bitrate.max_by_resolution` | åˆ†è¾¨ç‡å°é¡¶ç ç‡ï¼ˆæ–°ç‰ˆå¯é…ç½®ï¼‰|
| `keep_structure_flag` | `files.keep_structure` | ä¿æŒç›®å½•ç»“æ„ |
| `min_file_size` | `files.min_size_mb` | æœ€å°æ–‡ä»¶å¤§å° |
| `max_workers=3` | `-w 3` æˆ– `nvenc.max_concurrent: 3` | å¹¶å‘æ•° |

### æ—§ç¨‹åºçš„å›é€€æœºåˆ¶

**æ—§ç¨‹åº**ï¼š
1. å®Œå…¨GPUæ¨¡å¼ï¼ˆ`-hwaccel cuda -hwaccel_output_format cuda`ï¼‰
2. æ··åˆæ¨¡å¼ï¼ˆ`-hwaccel cuda`ï¼‰
3. æ ‡å‡†æ¨¡å¼ï¼ˆæ— ç¡¬ä»¶åŠ é€Ÿå‚æ•°ï¼‰

**æ–°ç¨‹åº**ï¼ˆæ›´å®Œå–„ï¼‰ï¼š
1. ç¡¬ä»¶å…¨åŠ é€Ÿï¼ˆç¡¬è§£+ç¡¬ç¼–ï¼‰
2. æ··åˆæ¨¡å¼+é™å¸§ï¼ˆè½¯è§£+ç¡¬ç¼–+30fpsï¼‰
3. æ··åˆæ¨¡å¼ï¼ˆè½¯è§£+ç¡¬ç¼–ï¼‰
4. CPUç¼–ç +é™å¸§
5. CPUç¼–ç 
6. libx264å›é€€ï¼ˆç»ˆæå…¼å®¹ï¼‰

## ğŸ“ å‘½ä»¤è¡Œç¤ºä¾‹

### å®Œå…¨æ¨¡æ‹Ÿæ—§ç¨‹åºè¡Œä¸º

```bash
python main.py \
  -i "F:/lada/output" \
  -o "F:/lada/pre" \
  -l "I:/BVC" \
  --hw-accel nvenc \
  -c hevc \
  -w 3 \
  --min-size 100
```

### å¯ç”¨è½¯ä»¶å›é€€ï¼ˆæ¨èï¼‰

```bash
python main.py \
  -i "F:/lada/output" \
  -o "F:/lada/pre" \
  --hw-accel nvenc \
  --enable-software-fallback
```

### å¤šGPUæ··åˆè°ƒåº¦ï¼ˆæœ€å¼ºå¤§ï¼‰

```bash
python main.py --multi-gpu \
  --encoders nvenc,qsv \
  --scheduler least_loaded \
  --max-concurrent 6
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. è·¯å¾„æ ¼å¼

**æ—§ç¨‹åº**ï¼šå¿…é¡»ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸² `r"F:\lada\output"`

**æ–°ç¨‹åº**ï¼šæ”¯æŒå¤šç§æ ¼å¼
- `"F:/lada/output"` âœ… æ¨è
- `"F:\\lada\\output"` âœ… å¯ç”¨
- `r"F:\lada\output"` âœ… å¯ç”¨ï¼ˆPythonå­—ç¬¦ä¸²ï¼‰

### 2. é»˜è®¤è¡Œä¸ºå·®å¼‚

| è¡Œä¸º | æ—§ç¨‹åº | æ–°ç¨‹åº | å»ºè®® |
|-----|--------|--------|------|
| å¤±è´¥å›é€€ | åªæœ‰3æ¬¡å°è¯• | æœ€å¤š6æ¬¡å°è¯• | ä¿æŒæ–°è¡Œä¸º |
| è·³è¿‡å·²å­˜åœ¨æ–‡ä»¶ | âœ… | âœ… | ä¸€è‡´ |
| é™åˆ¶å¸§ç‡ | âŒ | âœ… é»˜è®¤30fps | å¯é€šè¿‡`--no-fps-limit`å…³é—­ |
| CPUå…œåº• | âŒ | âœ… å¯é€‰ | å»ºè®®å¯ç”¨ |

### 3. ç ç‡æ§åˆ¶å˜åŒ–

**æ—§ç¨‹åº**ï¼šæœ€å¤§ç ç‡ç¡¬ç¼–ç åœ¨ä»£ç ä¸­

```python
# æ—§ç‰ˆæœ¬ç¡¬ç¼–ç 
if short_side <= 720:
    max_bitrate = 1500000  # æ— æ³•ä¿®æ”¹
elif short_side <= 1080:
    max_bitrate = 3000000  # æ— æ³•ä¿®æ”¹
```

**æ–°ç¨‹åº**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶çµæ´»é…ç½®

```yaml
encoding:
  bitrate:
    max_by_resolution:  # å¯ä»¥è‡ªç”±ä¿®æ”¹
      720: 1500000
      1080: 3000000
      1440: 5000000     # å¯æ·»åŠ æ›´å¤šæ¡£ä½
      2160: 9000000
```

**ä¼˜åŠ¿**ï¼š

- âœ… å¯æ ¹æ®å†…å®¹ç±»å‹è°ƒæ•´ï¼ˆåŠ¨ç”»å¯é™ä½ï¼Œå®æ™¯å¯æé«˜ï¼‰
- âœ… å¯æ·»åŠ è‡ªå®šä¹‰åˆ†è¾¨ç‡æ¡£ä½ï¼ˆå¦‚540pã€900pç­‰ï¼‰
- âœ… æ— éœ€ä¿®æ”¹ä»£ç å³å¯è°ƒæ•´ç­–ç•¥

è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ [docs/BITRATE_CONFIG.md](BITRATE_CONFIG.md)

### 4. æ€§èƒ½ä¼˜åŒ–

**æ—§ç¨‹åº**ï¼šå›ºå®š3çº¿ç¨‹

**æ–°ç¨‹åºä¼˜åŒ–å»ºè®®**ï¼š
- å•GPUï¼šä¿æŒ3çº¿ç¨‹ `nvenc.max_concurrent: 3`
- åŒGPUï¼šæé«˜åˆ°6çº¿ç¨‹ `nvenc.max_concurrent: 6`
- GPU+CPUæ··åˆï¼šä½¿ç”¨å¤šç¼–ç å™¨æ¨¡å¼ `--multi-gpu`

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æ–°ç¨‹åºè¾“å‡ºæ–‡ä»¶åä¸åŒï¼Ÿ
A: ä¸¤ä¸ªç¨‹åºè¾“å‡ºéƒ½æ˜¯`.mp4`æ ¼å¼ï¼Œä¿æŒç›®å½•ç»“æ„ä¹Ÿä¸€è‡´ã€‚å¦‚æœä¸åŒï¼Œæ£€æŸ¥`files.keep_structure`é…ç½®ã€‚

### Q2: æ€§èƒ½æ¯”æ—§ç¨‹åºæ…¢ï¼Ÿ
A: æ£€æŸ¥ä»¥ä¸‹é…ç½®ï¼š
- ç¡®ä¿`nvenc.max_concurrent`è®¾ç½®ä¸º3ï¼ˆä¸æ—§ç¨‹åºä¸€è‡´ï¼‰
- æ£€æŸ¥æ˜¯å¦è¯¯å¼€äº†å¸§ç‡é™åˆ¶ï¼š`--no-fps-limit`
- ç¡®è®¤ç¡¬ä»¶åŠ é€Ÿæ­£å¸¸ï¼šæŸ¥çœ‹æ—¥å¿—ä¸­çš„"ä½¿ç”¨xxxç¼–ç å™¨"

### Q3: èƒ½å¦å®Œå…¨ç¦ç”¨æ–°åŠŸèƒ½ï¼Œåªç”¨NVENCï¼Ÿ
A: å¯ä»¥ï¼Œä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š
```yaml
encoders:
  enabled: ["nvenc"]
  cpu_fallback: false
fps:
  limit_on_software_decode: false
  limit_on_software_encode: false
```

### Q4: å¦‚ä½•æŸ¥çœ‹è¯¦ç»†çš„ç¼–ç è¿‡ç¨‹ï¼Ÿ

A: æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ `logs/transcoding_YYYYMMDDHHMMSS.log`ï¼ŒåŒ…å«æ¯ä¸ªæ–‡ä»¶çš„ç¼–ç æ–¹æ³•ã€å›é€€è®°å½•ã€‚

### Q5: æ—§ç‰ˆæœ¬çš„ç ç‡å°é¡¶é€»è¾‘ä¸æ–°ç‰ˆæœ¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

A: **æ—§ç‰ˆæœ¬**ç¡¬ç¼–ç äº†720p(1.5M)ã€1080p(3M)ã€1440p(5M)ã€4K(9M)å››ä¸ªæ¡£ä½ï¼Œæ— æ³•ä¿®æ”¹ã€‚**æ–°ç‰ˆæœ¬**ä¿æŒç›¸åŒé»˜è®¤å€¼ï¼Œä½†å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è‡ªç”±è°ƒæ•´ï¼š

```yaml
encoding:
  bitrate:
    max_by_resolution:
      720: 1500000    # å¯ä¿®æ”¹
      1080: 3000000   # å¯ä¿®æ”¹
      1440: 5000000   # å¯æ·»åŠ 
      2160: 9000000   # å¯æ·»åŠ 
```

å¦‚æœä¸åšä»»ä½•ä¿®æ”¹ï¼Œä¸¤ä¸ªç‰ˆæœ¬çš„ç ç‡è¡Œä¸ºå®Œå…¨ä¸€è‡´ã€‚è¯¦è§ [docs/BITRATE_CONFIG.md](BITRATE_CONFIG.md)

### Q6: æƒ³è¦å®Œå…¨ç§»é™¤ç ç‡å°é¡¶æ€ä¹ˆåŠï¼Ÿ

A: åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®éå¸¸é«˜çš„å°é¡¶å€¼ï¼Œæˆ–åˆ é™¤ `max_by_resolution` é…ç½®é¡¹ï¼ˆä½¿ç”¨ä»£ç é»˜è®¤å€¼ï¼‰ã€‚å‚è€ƒ [docs/BITRATE_CONFIG.md](BITRATE_CONFIG.md) ä¸­çš„"åœºæ™¯5ï¼šç§»é™¤åˆ†è¾¨ç‡å°é¡¶"éƒ¨åˆ†ã€‚

## ğŸ“ˆ è¿ç§»æ£€æŸ¥æ¸…å•

- [ ] å®‰è£…Pythonä¾èµ– `pip install -r requirements.txt`
- [ ] ç¡®è®¤FFmpegå¯ç”¨ `ffmpeg -version`
- [ ] ä¿®æ”¹`config.yaml`ä¸­çš„è·¯å¾„é…ç½®
- [ ] è¿è¡Œå°æ‰¹é‡æµ‹è¯•ï¼ˆ5-10ä¸ªæ–‡ä»¶ï¼‰
- [ ] å¯¹æ¯”è¾“å‡ºè´¨é‡å’Œæ–‡ä»¶å¤§å°
- [ ] æ£€æŸ¥æ—¥å¿—ç¡®è®¤ç¼–ç å™¨ä½¿ç”¨æ­£ç¡®
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆå¤„ç†é€Ÿåº¦å¯¹æ¯”ï¼‰
- [ ] å…¨é‡è¿ç§»

## ğŸ’¡ æ¨èå‡çº§è·¯å¾„

### é˜¶æ®µ1ï¼šä¿å®ˆè¿ç§»ï¼ˆ1-2å¤©ï¼‰
ä½¿ç”¨æœ€å°é…ç½®ï¼Œå®Œå…¨æ¨¡æ‹Ÿæ—§ç¨‹åºè¡Œä¸ºï¼Œç¡®ä¿ç¨³å®šæ€§ã€‚

### é˜¶æ®µ2ï¼šå¯ç”¨å›é€€ï¼ˆ1å‘¨ï¼‰
å¯ç”¨`cpu_fallback: true`ï¼Œæé«˜æˆåŠŸç‡ã€‚

### é˜¶æ®µ3ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ2-4å‘¨ï¼‰
æ ¹æ®ç¡¬ä»¶ç¯å¢ƒå¯ç”¨å¤šç¼–ç å™¨æ··åˆè°ƒåº¦ï¼Œæå‡ååé‡ã€‚

## ğŸ“ æ”¯æŒ

å¦‚æœè¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. æ—§ç¨‹åºçš„é…ç½®å‚æ•°
2. æ–°ç¨‹åºçš„`config.yaml`å†…å®¹
3. æ—¥å¿—æ–‡ä»¶ç‰‡æ®µ
4. é”™è¯¯ä¿¡æ¯æˆªå›¾

---

**ç¥è¿ç§»é¡ºåˆ©ï¼æ–°ç¨‹åºå°†ä¸ºä½ å¸¦æ¥æ›´å¼ºå¤§ã€æ›´å¯é çš„è§†é¢‘å‹ç¼©ä½“éªŒã€‚** ğŸ‰
