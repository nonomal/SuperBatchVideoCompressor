# 码率配置说明

本文档详细说明如何配置SuperBatchVideoCompressor的码率计算规则。

## 📊 码率计算流程

SBVC使用智能码率计算系统，按以下优先级确定最终码率：

```
1. 强制码率 (forced) → 2. 原始码率×压缩比例 (ratio) → 3. 分辨率封顶 (max_by_resolution) → 4. 最小码率保护 (min)
```

## ⚙️ 配置项说明

### 完整配置示例

```yaml
encoding:
  bitrate:
    # 1. 强制码率（优先级最高）
    forced: 0  # 0 = 自动计算；>0 时直接使用此值，忽略其他规则

    # 2. 压缩比例
    ratio: 0.5  # 目标码率 = 原始码率 × 0.5

    # 3. 分辨率封顶（新功能）
    max_by_resolution:
      720: 1500000    # 720p: 1.5 Mbps
      1080: 3000000   # 1080p: 3 Mbps
      1440: 5000000   # 1440p (2K): 5 Mbps
      2160: 9000000   # 4K: 9 Mbps

    # 4. 最小码率保护
    min: 500000  # 最低 500 kbps
```

### 各配置项详解

#### 1. `forced` - 强制码率

**作用**：直接指定输出码率，忽略所有其他规则

**使用场景**：
- 需要精确控制文件大小
- 统一所有视频的码率
- 测试不同码率的效果

**示例**：
```yaml
forced: 5000000  # 所有视频统一使用 5 Mbps
```

#### 2. `ratio` - 压缩比例

**作用**：按原始码率的百分比计算目标码率

**推荐值**：
- `0.5` (50%): 平衡质量和大小（默认）
- `0.3` (30%): 更高压缩率，节省空间
- `0.7` (70%): 保留更多质量

**示例**：
```yaml
ratio: 0.3  # 原始 10 Mbps → 目标 3 Mbps
```

#### 3. `max_by_resolution` - 分辨率封顶（新功能）

**作用**：根据视频分辨率限制最大码率，防止小分辨率视频使用过高码率

**工作原理**：
1. 使用视频的**短边**（宽和高中较小的值）作为分辨率判断依据
2. 从小到大遍历配置的档位，找到第一个 ≥ 短边的档位
3. 如果超过所有档位，使用最高档位的码率

**示例**：
```yaml
max_by_resolution:
  480: 1000000    # 480p 及以下: 1 Mbps
  720: 1500000    # 720p: 1.5 Mbps
  1080: 3000000   # 1080p: 3 Mbps
  1440: 5000000   # 1440p: 5 Mbps
  2160: 9000000   # 4K: 9 Mbps
  4320: 15000000  # 8K: 15 Mbps
```

**匹配示例**：
| 视频分辨率 | 短边 | 匹配档位 | 最大码率 |
|-----------|------|---------|---------|
| 1280×720 | 720 | 720 | 1.5 Mbps |
| 1920×1080 | 1080 | 1080 | 3 Mbps |
| 1080×1920 (竖屏) | 1080 | 1080 | 3 Mbps |
| 2560×1440 | 1440 | 1440 | 5 Mbps |
| 3840×2160 | 2160 | 2160 | 9 Mbps |
| 7680×4320 | 4320 | 4320 | 15 Mbps |
| 1024×768 | 768 | 1080 | 3 Mbps (取下一档) |

#### 4. `min` - 最小码率保护

**作用**：防止过度压缩导致质量严重损失

**推荐值**：500000 (500 kbps)

## 💡 常见使用场景

### 场景1：默认配置（推荐）

```yaml
bitrate:
  forced: 0
  ratio: 0.5
  min: 500000
  max_by_resolution:
    720: 1500000
    1080: 3000000
    1440: 5000000
    2160: 9000000
```

**效果**：
- 720p 视频（原4M）→ 2M → 封顶1.5M ✅
- 1080p 视频（原10M）→ 5M → 封顶3M ✅
- 4K 视频（原50M）→ 25M → 封顶9M ✅

### 场景2：高质量压缩

```yaml
bitrate:
  forced: 0
  ratio: 0.7        # 保留70%码率
  min: 1000000      # 最低1Mbps
  max_by_resolution:
    720: 2000000    # 提高封顶值
    1080: 5000000
    1440: 8000000
    2160: 15000000
```

### 场景3：极限压缩

```yaml
bitrate:
  forced: 0
  ratio: 0.3        # 只保留30%码率
  min: 500000
  max_by_resolution:
    720: 1000000    # 降低封顶值
    1080: 2000000
    1440: 3500000
    2160: 6000000
```

### 场景4：统一码率

```yaml
bitrate:
  forced: 3000000  # 所有视频统一3Mbps
  ratio: 0.5       # 被忽略
  min: 500000      # 被忽略
  max_by_resolution:  # 被忽略
    # ...
```

### 场景5：移除分辨率封顶

如果不想要分辨率封顶，删除或注释掉 `max_by_resolution`：

```yaml
bitrate:
  forced: 0
  ratio: 0.5
  min: 500000
  # max_by_resolution:  # 注释掉，不使用封顶
```

或者设置非常高的值：

```yaml
bitrate:
  forced: 0
  ratio: 0.5
  min: 500000
  max_by_resolution:
    720: 50000000   # 50 Mbps，实际上不会生效
    1080: 50000000
    1440: 50000000
    2160: 50000000
```

## 🔧 高级技巧

### 1. 针对不同内容类型调整

**动画/卡通**（色彩简单，压缩友好）：
```yaml
ratio: 0.3  # 可以使用更低码率
max_by_resolution:
  1080: 2000000  # 降低封顶
```

**实景/电影**（细节丰富，需要更高码率）：
```yaml
ratio: 0.6  # 保留更多码率
max_by_resolution:
  1080: 5000000  # 提高封顶
```

### 2. 添加自定义分辨率档位

```yaml
max_by_resolution:
  360: 500000     # 低分辨率
  480: 1000000
  540: 1200000    # 自定义档位
  720: 1500000
  900: 2000000    # 自定义档位
  1080: 3000000
  1200: 3500000   # 自定义档位
  1440: 5000000
  2160: 9000000
  2880: 12000000  # 5K
  4320: 18000000  # 8K
```

### 3. 按HEVC编码特性优化

HEVC比H.264效率高约30-50%，可以使用更低码率达到相同质量：

```yaml
codec: hevc  # 使用HEVC编码
bitrate:
  ratio: 0.4  # 比H.264时更低的比例
  max_by_resolution:
    1080: 2500000  # HEVC下1080p用2.5Mbps足够
    2160: 7000000  # 4K用7Mbps
```

## 📊 码率计算示例

### 示例1：1080p视频，原始10Mbps

**配置**：
```yaml
forced: 0
ratio: 0.5
min: 500000
max_by_resolution:
  1080: 3000000
```

**计算过程**：
1. 强制码率检查：forced=0，跳过
2. 计算压缩后码率：10M × 0.5 = 5M
3. 应用分辨率封顶：min(5M, 3M) = 3M
4. 应用最小码率保护：max(3M, 0.5M) = 3M
5. **最终码率：3 Mbps** ✅

### 示例2：720p视频，原始2Mbps

**配置**：同上

**计算过程**：
1. 强制码率检查：跳过
2. 计算压缩后码率：2M × 0.5 = 1M
3. 应用分辨率封顶：min(1M, 1.5M) = 1M
4. 应用最小码率保护：max(1M, 0.5M) = 1M
5. **最终码率：1 Mbps** ✅

### 示例3：4K视频，原始80Mbps

**配置**：同上

**计算过程**：
1. 强制码率检查：跳过
2. 计算压缩后码率：80M × 0.5 = 40M
3. 应用分辨率封顶：min(40M, 9M) = 9M
4. 应用最小码率保护：max(9M, 0.5M) = 9M
5. **最终码率：9 Mbps** ✅

## 🚀 从旧配置迁移

如果你使用的是旧版本，代码中硬编码了最大码率，现在可以通过配置文件修改：

**旧版本（硬编码）**：
```python
# src/core/encoder.py (旧版本)
if short_side <= 720:
    max_bitrate = 1500000
elif short_side <= 1080:
    max_bitrate = 3000000
# ...
```

**新版本（可配置）**：
```yaml
# config.yaml
encoding:
  bitrate:
    max_by_resolution:
      720: 1500000    # 现在可以修改了！
      1080: 3000000   # 现在可以修改了！
      # 添加更多档位...
```

## 📝 注意事项

1. **配置优先级**：
   - 命令行 `--force-bitrate` > 配置文件 `forced` > 其他规则
   - 使用强制码率时，ratio、max_by_resolution、min都会被忽略

2. **分辨率判断**：
   - 使用**短边**而非长边，正确处理竖屏视频
   - 1080×1920竖屏 和 1920×1080横屏 都按1080p处理

3. **封顶逻辑**：
   - 如果没有配置 `max_by_resolution`，使用代码默认值
   - 超过所有档位的分辨率，使用最高档位的码率

4. **最小码率**：
   - 始终生效，防止码率过低导致严重质量损失
   - 建议不低于 500kbps

## 🆘 故障排除

### 问题1：修改配置后没有生效

**检查**：
1. 确认修改的是正确的配置文件（`config.yaml` 而不是 `config-example.yaml`）
2. 检查YAML格式是否正确（缩进、冒号后空格等）
3. 重新启动程序

### 问题2：码率没有按预期封顶

**检查**：
1. 确认视频分辨率，使用 `ffprobe -v error -show_entries stream=width,height video.mp4`
2. 检查是否使用了 `--force-bitrate` 命令行参数（会覆盖配置）
3. 检查 `forced` 是否设置为非0值

### 问题3：所有视频都使用相同码率

**原因**：可能设置了 `forced`

**解决**：
```yaml
bitrate:
  forced: 0  # 确保为 0
```

---

**文档版本**：1.0
**更新日期**：2025-12-05
**适用版本**：v2.0.0+
