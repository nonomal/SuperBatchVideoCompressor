name: Test

on:
  push:
    branches: [main, master, dev]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'cli.py'
      - 'main.py'
      - 'requirements.txt'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [main, master, dev]
    paths:
      - 'src/**'
      - 'tests/**'
      - '*.py'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  PYTHONIOENCODING: 'utf-8'

jobs:
  # 代码质量检查
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linters
        run: pip install ruff

      - name: Run Ruff linter
        run: ruff check src/ tests/ cli.py main.py --output-format=github || true

      - name: Check syntax errors
        run: |
          python -m py_compile cli.py main.py
          find src -name "*.py" -exec python -m py_compile {} \;

  # 单元测试 (每个系统一个 Job，内部串行测试多个 Python 版本)
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: ubuntu-22.04, versions: "3.10\n3.11\n3.12\n3.13\n3.14" }
          - { os: ubuntu-24.04, versions: "3.10\n3.11\n3.12\n3.13\n3.14" }
          - { os: ubuntu-24.04-arm, versions: "3.10\n3.11\n3.12\n3.13\n3.14" }
          - { os: windows-2022, versions: "3.10\n3.11\n3.12\n3.13\n3.14" }
          - { os: windows-2025, versions: "3.10\n3.11\n3.12\n3.13\n3.14" }
          - { os: windows-11-arm, versions: "3.12\n3.13" }
          - { os: macos-15-intel, versions: "3.10\n3.11\n3.12\n3.13\n3.14" }
          - { os: macos-15, versions: "3.11\n3.12\n3.13\n3.14" }
          - { os: macos-26, versions: "3.11\n3.12\n3.13\n3.14" }

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python versions
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.versions }}
          allow-prereleases: true

      - name: Run tests on all Python versions (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          VERSIONS="${{ matrix.versions }}"
          for version in $VERSIONS; do
            echo ""
            echo "::group::Testing Python $version"
            echo "=========================================="

            PYTHON_CMD="python${version}"
            if ! command -v $PYTHON_CMD &> /dev/null; then
              PYTHON_CMD="python"
            fi

            $PYTHON_CMD --version
            $PYTHON_CMD -m pip install --upgrade pip -q
            $PYTHON_CMD -m pip install -r requirements.txt -q
            $PYTHON_CMD -m pip install pytest -q
            $PYTHON_CMD -m pytest tests/ -v --tb=short

            echo "::endgroup::"
          done

      - name: Set Windows Console to UTF-8
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # 设置控制台代码页为UTF-8
          chcp 65001
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8

      - name: Run tests on all Python versions (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # 确保UTF-8编码
          chcp 65001 > $null
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8

          $versions = @("${{ matrix.versions }}" -split "`n")
          foreach ($version in $versions) {
            $version = $version.Trim()
            if ([string]::IsNullOrEmpty($version)) { continue }

            Write-Host ""
            Write-Host "::group::Testing Python $version"
            Write-Host "=========================================="

            py -$version --version
            py -$version -m pip install --upgrade pip -q
            py -$version -m pip install -r requirements.txt -q
            py -$version -m pip install pytest -q
            py -$version -m pytest tests/ -v --tb=short

            Write-Host "::endgroup::"
          }

  # CLI 功能测试
  cli-test:
    name: CLI Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Test CLI
        run: |
          python cli.py --help
          python main.py --help

  # 目录保持功能专项测试
  keep-structure-test:
    name: Keep Directory Structure Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pytest pyyaml

      - name: Run keep_structure tests
        run: |
          pytest tests/test_keep_structure.py -v --tb=short

      - name: Generate test report
        if: always()
        run: |
          echo "## 目录保持功能测试结果" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ 所有测试通过！目录保持功能正常工作。" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 测试覆盖的场景：" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ 根目录文件" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ 单级子目录" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ 多级嵌套子目录" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ 中文路径支持" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Windows 路径格式" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ 不保持目录结构（扁平化输出）" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ 文件扩展名转换" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ 临时文件位置正确性" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ 路径映射一致性" >> $GITHUB_STEP_SUMMARY
